<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>The powerful MongoBson library | ET</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/logo1.png">
    <meta name="description" content="ET是一个开源的游戏客户端基于『unity3d』服务端双端框架">
    <meta name="keywords" content="ET,et,game,framework,ECS,Server">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.8127fba6.css" as="style"><link rel="preload" href="/assets/js/app.ffc2a9fd.js" as="script"><link rel="preload" href="/assets/js/2.fbbdf61d.js" as="script"><link rel="preload" href="/assets/js/28.2eb24b37.js" as="script"><link rel="prefetch" href="/assets/js/10.e97fa32e.js"><link rel="prefetch" href="/assets/js/11.54d332e4.js"><link rel="prefetch" href="/assets/js/12.f44a82d3.js"><link rel="prefetch" href="/assets/js/13.6a997ef1.js"><link rel="prefetch" href="/assets/js/14.91eebba8.js"><link rel="prefetch" href="/assets/js/15.f0fe1a2f.js"><link rel="prefetch" href="/assets/js/16.f6a93be8.js"><link rel="prefetch" href="/assets/js/17.e69838fc.js"><link rel="prefetch" href="/assets/js/18.b4d244df.js"><link rel="prefetch" href="/assets/js/19.77ce86be.js"><link rel="prefetch" href="/assets/js/20.522c38c6.js"><link rel="prefetch" href="/assets/js/21.5ddc1ccf.js"><link rel="prefetch" href="/assets/js/22.99e8ee68.js"><link rel="prefetch" href="/assets/js/23.82c4363e.js"><link rel="prefetch" href="/assets/js/24.be760363.js"><link rel="prefetch" href="/assets/js/25.9cf1c272.js"><link rel="prefetch" href="/assets/js/26.63cf55ed.js"><link rel="prefetch" href="/assets/js/27.1b095ee3.js"><link rel="prefetch" href="/assets/js/29.ed14162b.js"><link rel="prefetch" href="/assets/js/3.8494f848.js"><link rel="prefetch" href="/assets/js/30.5dcfd290.js"><link rel="prefetch" href="/assets/js/31.3dc6860b.js"><link rel="prefetch" href="/assets/js/32.5b6b946d.js"><link rel="prefetch" href="/assets/js/33.b6c2eaeb.js"><link rel="prefetch" href="/assets/js/34.60de0211.js"><link rel="prefetch" href="/assets/js/35.12f403f4.js"><link rel="prefetch" href="/assets/js/36.a30ab135.js"><link rel="prefetch" href="/assets/js/37.83ffe510.js"><link rel="prefetch" href="/assets/js/38.1465e967.js"><link rel="prefetch" href="/assets/js/39.0e48601a.js"><link rel="prefetch" href="/assets/js/4.cd0c8f84.js"><link rel="prefetch" href="/assets/js/40.6349f9cb.js"><link rel="prefetch" href="/assets/js/5.2d050595.js"><link rel="prefetch" href="/assets/js/6.42e16043.js"><link rel="prefetch" href="/assets/js/7.8e7e3e5a.js"><link rel="prefetch" href="/assets/js/8.58eb5208.js"><link rel="prefetch" href="/assets/js/9.79c3d2c0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8127fba6.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo1.png" alt="ET" class="logo"> <span class="site-name can-hide">ET</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="指南" class="dropdown-title"><!----> <span class="title" style="display:;">指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/a2f161/" class="nav-link">指南</a></li><li class="dropdown-item"><!----> <a href="/pages/1e1b9a/" class="nav-link">Guide</a></li><li class="dropdown-item"><!----> <a href="/doc/notes/" class="nav-link">提交文档</a></li></ul></div></div><div class="nav-item"><a href="https://et-framework.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  论坛
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/egametang/ET" target="_blank" rel="noopener noreferrer" class="nav-link external">
  💖ET-Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/zxt385189207/ET-homepage" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="指南" class="dropdown-title"><!----> <span class="title" style="display:;">指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/a2f161/" class="nav-link">指南</a></li><li class="dropdown-item"><!----> <a href="/pages/1e1b9a/" class="nav-link">Guide</a></li><li class="dropdown-item"><!----> <a href="/doc/notes/" class="nav-link">提交文档</a></li></ul></div></div><div class="nav-item"><a href="https://et-framework.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  论坛
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/egametang/ET" target="_blank" rel="noopener noreferrer" class="nav-link external">
  💖ET-Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/zxt385189207/ET-homepage" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>ETBook_English</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/1e1b9a/" class="sidebar-link">RunGuide</a></li><li><a href="/pages/f9f601/" class="sidebar-link">Why use .net core</a></li><li><a href="/pages/97d2cf/" class="sidebar-link">CSharp Coroutine</a></li><li><a href="/pages/e03bce/" class="sidebar-link">Better Coroutine</a></li><li><a href="/pages/735741/" class="sidebar-link">Single-threaded asynchronous</a></li><li><a href="/pages/947d76/" aria-current="page" class="active sidebar-link">The powerful MongoBson library</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/b631b2/" class="sidebar-link">Everything is Entity</a></li><li><a href="/pages/53296b/" class="sidebar-link">EventSystem</a></li><li><a href="/pages/66fec6/" class="sidebar-link">Component-based design</a></li><li><a href="/pages/a3279e/" class="sidebar-link">Actor Model</a></li><li><a href="/pages/d00821/" class="sidebar-link">Actor Location-EN</a></li><li><a href="/pages/ae8fe0/" class="sidebar-link">Numerical component design</a></li><li><a href="/pages/58cf5c/" class="sidebar-link">AI Framwork</a></li><li><a href="/pages/b70448/" class="sidebar-link">test2</a></li><li><a href="/pages/578b97/" class="sidebar-link">test</a></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Guide</span></li><li data-v-06225672><span data-v-06225672>ETBook_English</span></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/egametang/ET" target="_blank" title="作者" class="beLink" data-v-06225672>熊猫</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-05-31</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">The powerful MongoBson library<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="the-powerful-mongobson-library"><a href="#the-powerful-mongobson-library" class="header-anchor">#</a> The powerful MongoBson library</h1> <p>Back-end development, statistics about these scenarios need to use serialization: 1.</p> <ol><li>object clone by serialization deserialization</li> <li>server-side database storage data, binary</li> <li>distributed server-side, multi-process messages, binary</li> <li>back-end logs, text format</li> <li>various server-side configuration files, text format</li></ol> <p>There are very, very many C# serialization libraries, protobuf, json and so on. But these serialization libraries should not be readable and small for all scenarios. protobuf does not support complex object structures (cannot use inheritance) and is suitable for messages, but not for database storage and log formats. json is suitable for log formats, but is too big for network messages and data storage. We certainly want a library that can satisfy all the above scenarios for the following reasons.</p> <ol><li>you think about one day your configuration file needs to be saved in the database, you do not need to do the format conversion, the back-end directly to the configuration message sent by the front-end to save to the database, which can not reduce very many errors?</li> <li>one day some server-side configuration files do not use the file format, need to be placed in the database, again, only a few lines of code to complete the migration.</li> <li>one day the back-end server crash, you need to scan the logs for data recovery, the logs for deserialization into C# objects, one by one for processing, and then into objects saved to the database is complete.</li> <li>objects saved in the database, you can directly see the text content, you can do a variety of SQL-like operations</li> <li>Imagine a scenario where a configuration text object, deserialized into memory, sent via network messages, and stored in the database. The whole process is done in one go.</li></ol> <p>Simply put, it reduces various data conversions, reduces code, improves development efficiency, and improves maintainability. MongoDB library can serialize both text and BSON binary format, and MongoDB itself is a very much used database in the game. Its support features are as follows.</p> <ol><li>support complex inheritance structure</li> <li>support for ignoring certain fields serialization</li> <li>support field default values</li> <li>structure with extra fields can still be deserialized, which is very useful for multi-version protocols</li> <li>support for ISupportInitialize interface, this is a godsend when deserialization</li> <li>support for text json and binary bson serialization</li> <li>MongoDB database support</li></ol> <p>A brief introduction to the mongo bson library</p> <h3 id="_1-support-serialization-deserialization-into-json-or-bson"><a href="#_1-support-serialization-deserialization-into-json-or-bson" class="header-anchor">#</a> 1. Support serialization deserialization into json or bson</h3> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Player</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">long</span></span> Id<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Account <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">long</span></span> UnitId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Player</span> player1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Player</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> Id <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">string</span></span> json <span class="token operator">=</span> player1<span class="token punctuation">.</span><span class="token function">ToJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;player1 to json: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">json</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;player to bson: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">player<span class="token punctuation">.</span><span class="token function">ToBson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToHex</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// output:</span>
    <span class="token comment">// player to json: { &quot;_id&quot; : NumberLong(1), &quot;C&quot; : [], &quot;Account&quot; : null, &quot;UnitId&quot; : NumberLong(0) }</span>
    <span class="token comment">// player to bson: B000000125F69640001000000000000000A4163636F756E740012556E69744964000000000000000000000000</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>Note that mongo's json is a bit different from the standard json, if you want to use the standard json, you can pass in a JsonWriterSettings object and restrict the use of JsonOutputMode.Strict mode</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code>    <span class="token comment">// use standard json</span>
    <span class="token class-name">Player</span> player2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Player</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> Id <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;player to json: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">player2<span class="token punctuation">.</span><span class="token function">ToJson</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">JsonWriterSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>OutputMode <span class="token operator">=</span> JsonOutputMode<span class="token punctuation">.</span>Strict<span class="token punctuation">}</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// player to json: { &quot;_id&quot; : 1, &quot;C&quot; : [], &quot;Account&quot; : null, &quot;UnitId&quot; : 0 }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>Deserialize json:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code>            <span class="token comment">// deserialize json</span>
        <span class="token class-name">Player</span> player11 <span class="token operator">=</span> BsonSerializer<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Deserialize</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Player<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;player11 to json: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">player11<span class="token punctuation">.</span><span class="token function">ToJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Deserialize bson:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code>    <span class="token comment">// deserialize bson</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">MemoryStream</span> memoryStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MemoryStream</span><span class="token punctuation">(</span>bson<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">Player</span> player12 <span class="token operator">=</span> <span class="token punctuation">(</span>Player<span class="token punctuation">)</span> BsonSerializer<span class="token punctuation">.</span><span class="token function">Deserialize</span><span class="token punctuation">(</span>memoryStream<span class="token punctuation">,</span> <span class="token keyword">typeof</span> <span class="token punctuation">(</span><span class="token type-expression class-name">Player</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;player12 to json: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">player12<span class="token punctuation">.</span><span class="token function">ToJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="_2-some-fields-can-be-ignored"><a href="#_2-some-fields-can-be-ignored" class="header-anchor">#</a> 2. Some fields can be ignored</h3> <p>[BsonIgnore] This tag is used to disable field serialization.</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code>	<span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Player</span>
	<span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">long</span></span> Id<span class="token punctuation">;</span>

		<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">BsonIgnore</span></span><span class="token punctuation">]</span>
		<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Account <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
		
		<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">long</span></span> UnitId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Player</span> player <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Player</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> Id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> UnitId <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> Account <span class="token operator">=</span> <span class="token string">&quot;panda&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;player to json: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">player<span class="token punctuation">.</span><span class="token function">ToJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// player to json: { &quot;_id&quot; : 2, &quot;UnitId&quot; : 3 }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="_3-support-for-default-values-and-taking-aliases"><a href="#_3-support-for-default-values-and-taking-aliases" class="header-anchor">#</a> 3. Support for default values and taking aliases</h3> <p>The [BsonElement] field with this tag will serialize even private fields (only public fields are serialized by default), and the tag can take a string parameter to assign an alias to the field serialization.</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code>	<span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Player</span>
	<span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">long</span></span> Id<span class="token punctuation">;</span>

		<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Account <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

		<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">BsonElement</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;UId&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
		<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">long</span></span> UnitId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Player</span> player <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Player</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> Id <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span> UnitId <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span> Account <span class="token operator">=</span> <span class="token string">&quot;panda&quot;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;player to json: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">player<span class="token punctuation">.</span><span class="token function">ToJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// player to json: { &quot;_id&quot; : 2, &quot;Account&quot; : &quot;panda&quot;, &quot;UId&quot; : 3 }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="_4-upgrade-version-support"><a href="#_4-upgrade-version-support" class="header-anchor">#</a> 4. Upgrade version support</h3> <p>[BsonIgnoreExtraElements] This tag is used on top of class, used to ignore extra fields when deserializing, general version compatibility needs to be considered, low version of the protocol needs to be able to deserialize
otherwise the new version adds fields, the old version structure deserialization will be wrong</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code>	<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">BsonIgnoreExtraElements</span></span><span class="token punctuation">]</span>
	<span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Player</span>
	<span class="token keyword">public</span>
        <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">long</span></span> Id<span class="token punctuation">;</span>

		<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Account <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

		<span class="token punctuation">[</span><span class="token function">BsonElement</span><span class="token punctuation">(</span><span class="token string">&quot;UId&quot;</span><span class="token punctuation">)</span>
		<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">long</span></span> UnitId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="_5-support-for-complex-inheritance-structures"><a href="#_5-support-for-complex-inheritance-structures" class="header-anchor">#</a> 5. Support for complex inheritance structures</h3> <p>The power of the mongo bson library is that it fully supports serialization deserialization inheritance structures. Note that inheritance deserialization requires registration of all parent classes, and there are two ways to do this.
a. You can declare the inherited subclasses on top of the parent class using the [BsonKnownTypes] tag, so that mongo will automatically register them, e.g.:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code>    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">BsonKnownTypes</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Entity</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Component</span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">BsonKnownTypes</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Player</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Entity</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Component</span></span>
    <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">Player</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Entity</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">long</span></span> Id<span class="token punctuation">;</span>
        
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Account <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
		
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">long</span></span> UnitId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>This is flawed because the framework doesn't know what subclasses a class will have, and this is invasive to the framework code, and we want to uncouple this
. You can scan the assembly for the types of all subclass parents and register them with the mongo driver</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code>			<span class="token class-name">Type<span class="token punctuation">[</span><span class="token punctuation">]</span></span> types <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Game</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">.</span><span class="token function">GetTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">Type</span> type <span class="token keyword">in</span> types<span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>type<span class="token punctuation">.</span><span class="token function">IsSubclassOf</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">Component</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">{</span>
					<span class="token keyword">continue</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				BsonClassMap<span class="token punctuation">.</span><span class="token function">LookupClassMap</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			BsonSerializer<span class="token punctuation">.</span><span class="token function">RegisterSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">EnumSerializer<span class="token punctuation">&lt;</span>NumericType<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>BsonType<span class="token punctuation">.</span>String<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>This completely automates the registration and the user does not need to relate whether the class is registered or not.</p> <h3 id="_6-isupportinitialize-interface"><a href="#_6-isupportinitialize-interface" class="header-anchor">#</a> 6. ISupportInitialize interface</h3> <p>mongo bson deserialization supports an ISupportInitialize interface, ISupportInitialize has two methods</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ISupportInitialize</span>
    <span class="token punctuation">{</span>
        <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">BeginInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">EndInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>BeginInit is called before deserialization and EndInit is called after deserialization. This interface is very useful now to perform some operations after deserialization. For example</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code>	<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">BsonIgnoreExtraElements</span></span><span class="token punctuation">]</span>
	<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InnerConfig</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AConfigComponent</span></span>
	<span class="token punctuation">{</span>
		<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">BsonIgnore</span></span><span class="token punctuation">]</span>
		<span class="token keyword">public</span> <span class="token return-type class-name">IPEndPoint</span> IPEndPoint <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
		
		<span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Address <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

		<span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">EndInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>IPEndPoint <span class="token operator">=</span> NetworkHelper<span class="token punctuation">.</span><span class="token function">ToIPEndPoint</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Address<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>InnerConfig is the configuration of the process inner network address in ET. Since IPEndPoint is not very configurable, we can configure it as a string and then convert the string to IPEndPoint in EndInit when deserializing.
I also added this call to the protobuf deserialization method, refer to ProtobufHelper.cs, ET's protobuf because to support ilruntime, so remove the map support, if we want a map how to do? Here I gave the generated code are done, the proto messages are changed to a partial class, so that we can extend the class themselves, for example.</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token return-type class-name">message</span> UnitInfo
<span class="token punctuation">{</span>
	<span class="token class-name">int64</span> UnitId <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

	<span class="token class-name"><span class="token keyword">float</span></span> X <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token class-name"><span class="token keyword">float</span></span> Y <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
	<span class="token class-name"><span class="token keyword">float</span></span> Z <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// protobuf</span>
message G2C_EnterMap <span class="token comment">// IResponse</span>
<span class="token punctuation">{</span>
	<span class="token class-name">int32</span> RpcId <span class="token operator">=</span> <span class="token number">90</span><span class="token punctuation">;</span>
	<span class="token class-name">int32</span> Error <span class="token operator">=</span> <span class="token number">91</span><span class="token punctuation">;</span>
	<span class="token class-name"><span class="token keyword">string</span></span> Message <span class="token operator">=</span> <span class="token number">92</span><span class="token punctuation">;</span>
	<span class="token comment">// own unit id</span>
	<span class="token class-name">int64</span> UnitId <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token comment">// all the units</span>
	repeated <span class="token class-name">UnitInfo</span> Units <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>This network message has a repeated UnitInfo field, which is actually an array in protobuf, which is not very convenient to use, I want to convert it to a Dictionary&lt;Int64, UnitInfo&gt; field, we can do something like this</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">partial</span> <span class="token keyword">class</span> <span class="token class-name">G2C_EnterMap</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ISupportInitialize</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token class-name">Dictionary<span class="token punctuation">&lt;</span>Int64<span class="token punctuation">,</span> UnitInfo<span class="token punctuation">&gt;</span></span> unitsDict <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Dictionary<span class="token punctuation">&lt;</span><span class="token keyword">long</span><span class="token punctuation">,</span> UnitInfo<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">BeginInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">EndInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> unit <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>Units<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>unitsDict<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>unit<span class="token punctuation">.</span>UnitId<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>The message is extended by such a piece of code, and after deserialization, it is automatically converted into a Dictionary.</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/zxt385189207/ET-homepage/edit/main/docs/02.Guide/01.ETBook_English/32.3.2The powerful MongoBson library.md" target="_blank" rel="noopener noreferrer">在Github上编辑此页面!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/07/25, 23:10:19</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/735741/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Single-threaded asynchronous</div></a> <a href="/pages/b631b2/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Everything is Entity</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/735741/" class="prev">Single-threaded asynchronous</a></span> <span class="next"><a href="/pages/b631b2/">Everything is Entity</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:385189207@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/egametang/ET" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2022
    <span>d | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ffc2a9fd.js" defer></script><script src="/assets/js/2.fbbdf61d.js" defer></script><script src="/assets/js/28.2eb24b37.js" defer></script>
  </body>
</html>
