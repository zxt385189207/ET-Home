<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Actor Model | ET</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/logo1.png">
    <meta name="description" content="ET是一个开源的游戏客户端基于『unity3d』服务端双端框架">
    <meta name="keywords" content="ET,et,game,framework,ECS,Server">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.8127fba6.css" as="style"><link rel="preload" href="/assets/js/app.ffc2a9fd.js" as="script"><link rel="preload" href="/assets/js/2.fbbdf61d.js" as="script"><link rel="preload" href="/assets/js/32.5b6b946d.js" as="script"><link rel="prefetch" href="/assets/js/10.e97fa32e.js"><link rel="prefetch" href="/assets/js/11.54d332e4.js"><link rel="prefetch" href="/assets/js/12.f44a82d3.js"><link rel="prefetch" href="/assets/js/13.6a997ef1.js"><link rel="prefetch" href="/assets/js/14.91eebba8.js"><link rel="prefetch" href="/assets/js/15.f0fe1a2f.js"><link rel="prefetch" href="/assets/js/16.f6a93be8.js"><link rel="prefetch" href="/assets/js/17.e69838fc.js"><link rel="prefetch" href="/assets/js/18.b4d244df.js"><link rel="prefetch" href="/assets/js/19.77ce86be.js"><link rel="prefetch" href="/assets/js/20.522c38c6.js"><link rel="prefetch" href="/assets/js/21.5ddc1ccf.js"><link rel="prefetch" href="/assets/js/22.99e8ee68.js"><link rel="prefetch" href="/assets/js/23.82c4363e.js"><link rel="prefetch" href="/assets/js/24.be760363.js"><link rel="prefetch" href="/assets/js/25.9cf1c272.js"><link rel="prefetch" href="/assets/js/26.63cf55ed.js"><link rel="prefetch" href="/assets/js/27.1b095ee3.js"><link rel="prefetch" href="/assets/js/28.2eb24b37.js"><link rel="prefetch" href="/assets/js/29.ed14162b.js"><link rel="prefetch" href="/assets/js/3.8494f848.js"><link rel="prefetch" href="/assets/js/30.5dcfd290.js"><link rel="prefetch" href="/assets/js/31.3dc6860b.js"><link rel="prefetch" href="/assets/js/33.b6c2eaeb.js"><link rel="prefetch" href="/assets/js/34.60de0211.js"><link rel="prefetch" href="/assets/js/35.12f403f4.js"><link rel="prefetch" href="/assets/js/36.a30ab135.js"><link rel="prefetch" href="/assets/js/37.83ffe510.js"><link rel="prefetch" href="/assets/js/38.1465e967.js"><link rel="prefetch" href="/assets/js/39.0e48601a.js"><link rel="prefetch" href="/assets/js/4.cd0c8f84.js"><link rel="prefetch" href="/assets/js/40.6349f9cb.js"><link rel="prefetch" href="/assets/js/5.2d050595.js"><link rel="prefetch" href="/assets/js/6.42e16043.js"><link rel="prefetch" href="/assets/js/7.8e7e3e5a.js"><link rel="prefetch" href="/assets/js/8.58eb5208.js"><link rel="prefetch" href="/assets/js/9.79c3d2c0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8127fba6.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo1.png" alt="ET" class="logo"> <span class="site-name can-hide">ET</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="指南" class="dropdown-title"><!----> <span class="title" style="display:;">指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/a2f161/" class="nav-link">指南</a></li><li class="dropdown-item"><!----> <a href="/pages/1e1b9a/" class="nav-link">Guide</a></li><li class="dropdown-item"><!----> <a href="/doc/notes/" class="nav-link">提交文档</a></li></ul></div></div><div class="nav-item"><a href="https://et-framework.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  论坛
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/egametang/ET" target="_blank" rel="noopener noreferrer" class="nav-link external">
  💖ET-Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/zxt385189207/ET-homepage" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="指南" class="dropdown-title"><!----> <span class="title" style="display:;">指南</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/a2f161/" class="nav-link">指南</a></li><li class="dropdown-item"><!----> <a href="/pages/1e1b9a/" class="nav-link">Guide</a></li><li class="dropdown-item"><!----> <a href="/doc/notes/" class="nav-link">提交文档</a></li></ul></div></div><div class="nav-item"><a href="https://et-framework.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  论坛
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://github.com/egametang/ET" target="_blank" rel="noopener noreferrer" class="nav-link external">
  💖ET-Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <a href="https://github.com/zxt385189207/ET-homepage" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>ETBook_English</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/1e1b9a/" class="sidebar-link">RunGuide</a></li><li><a href="/pages/f9f601/" class="sidebar-link">Why use .net core</a></li><li><a href="/pages/97d2cf/" class="sidebar-link">CSharp Coroutine</a></li><li><a href="/pages/e03bce/" class="sidebar-link">Better Coroutine</a></li><li><a href="/pages/735741/" class="sidebar-link">Single-threaded asynchronous</a></li><li><a href="/pages/947d76/" class="sidebar-link">The powerful MongoBson library</a></li><li><a href="/pages/b631b2/" class="sidebar-link">Everything is Entity</a></li><li><a href="/pages/53296b/" class="sidebar-link">EventSystem</a></li><li><a href="/pages/66fec6/" class="sidebar-link">Component-based design</a></li><li><a href="/pages/a3279e/" aria-current="page" class="active sidebar-link">Actor Model</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/d00821/" class="sidebar-link">Actor Location-EN</a></li><li><a href="/pages/ae8fe0/" class="sidebar-link">Numerical component design</a></li><li><a href="/pages/58cf5c/" class="sidebar-link">AI Framwork</a></li><li><a href="/pages/b70448/" class="sidebar-link">test2</a></li><li><a href="/pages/578b97/" class="sidebar-link">test</a></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>Guide</span></li><li data-v-06225672><span data-v-06225672>ETBook_English</span></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/egametang/ET" target="_blank" title="作者" class="beLink" data-v-06225672>熊猫</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-05-31</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">Actor Model<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="actor-model"><a href="#actor-model" class="header-anchor">#</a> Actor model</h1> <h3 id="actor-introduction"><a href="#actor-introduction" class="header-anchor">#</a> Actor introduction</h3> <p>Before discussing the Actor model, we should discuss the architecture of ET. There are two architectures for game servers in order to use multi-core, single-threaded multi-process and single-process multi-threaded architecture. ET uses single-threaded multi-process architecture, while the traditional Actor model is generally single-process multi-threaded architecture, which is a major difference. The advantages and disadvantages are as follows.</p> <ol><li>the logic needs to be single-threaded this is the same, erlang process logic is single-threaded, skynet lua virtual machine is also single-threaded. et in a process is actually equivalent to an erlang process, a skynet lua virtual machine.</li> <li>the use of single-threaded multi-process does not need to write their own set of profiler tools, you can use a lot of ready-made profiler tools, such as view memory, cpu occupation directly with top command, this point erlang and skynet need to get another set of tools.</li> <li>multi-process single-threaded architecture also has a benefit, a single physical machine and multiple physical machines is no difference, single process multi-threaded also need to consider the processing of multiple physical machines.</li> <li>multi-process single-threaded architecture is a bit of a drawback is that messages need to be serialized and deserialized across processes, taking up a bit of resources. In addition, sending network messages will have a few milliseconds delay. Generally these effects can be ignored.</li></ol> <p>The original Actor model is used for single-process multi-threaded architecture, there is a reason for this, because multi-threaded architecture developers can easily access shared variables at will, let's say a variable a, thread 1 can access, thread 2 can also access, so that both threads need to add locks when accessing the variable a, shared variables more locks everywhere, will become unmaintainable, the framework must not appear The framework must not have a situation where there are threads sharing variables everywhere. In order to ensure that the multi-threaded architecture does not go wrong, it is necessary to provide a development model that ensures easy and safe multi-threaded development. erlang's concurrency mechanism is the actor model. erlang virtual machine uses multiple threads to take advantage of multiple cores. erlang has designed a mechanism that designs its own processes on top of the virtual machine. At its simplest, each erlang process manages its own variables, and the logic of each erlang process runs on a single thread. The logic between the erlang process and the process is completely isolated, so that there are no two threads accessing the same variable and there is no multithreaded competition. The next question arises, since each erlang process has its own data and the logic is completely isolated, how should the two erlang processes communicate with each other? This is where the Actor model comes in. erlang has designed a messaging mechanism: one process can send messages to other processes, and erlang processes communicate with each other through messages. Isn't this the same message queue used by operating systems for inter-process communication? Yes, in fact, it is similar. erlang inside the process id to get the process can send messages to this process.</p> <p>If the message is only sent to the process, it is still a bit inconvenient. For example, if you take an erlang process as a moba team process, and there are 10 players in the battle process, if you use erlang's actor message, the message can only be sent to the battle process, but often the message needs to be sent to a player, then erlang needs to distribute the message to the specific player again according to the player id in the message, so it actually goes around one more time. This is actually an extra detour.</p> <h3 id="et-s-actor"><a href="#et-s-actor" class="header-anchor">#</a> ET's Actor</h3> <p>According to the characteristics of its own architecture, ET does not completely copy the Actor model of erlang, but provides the Entity object-level Actor model. In ET, an Actor is an Entity object, and a MailboxComponent component attached to an Entity is an Actor. You only need to know the Entity's InstanceId to send messages to the Entity. In fact, erlang's Actor model is a special case of ET, such as giving the ET server Game.Scene as an Actor, so that it can become a process-level Actor. It only needs to know the InstanceId (ET) or the Pid (erlang) of the process to send it to the other party.</p> <p>| Language | ET | Erlang | Skynet |
| | ET | Erlang | Skynet | -- | :--: | :--: | :--: |
| Architecture | Single-Threaded Multi-Process | Single-Process Multi-Threaded | Single-Process Multi-Threaded |
| Actor | Entity | erlang process | lua virtual machine |
| ActorId | Entity.InstanceId | erlang processId | service address |</p> <h3 id="use-of-et-s-actor"><a href="#use-of-et-s-actor" class="header-anchor">#</a> Use of ET's Actor</h3> <p>For a normal Actor, we can refer to the Gate Session. map has a Unit, and the Unit holds the gate session corresponding to the player. thus, if a message in map needs to be sent to the client, it only needs to send the message to the gate session, and the gate session forwards it to the client when it receives the message. The map process sending messages to the gate session is a typical actor model. It doesn't need to know the location of the gate session, it just needs to know its InstanceId. messageHelper.cs gets an ActorMessageSender from GateSessionActorId and sends it.</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token comment">// Get an ActorSenderComponent from Game.Scene, then get an ActorMessageSender by InstanceId</span>
<span class="token class-name">ActorSenderComponent</span> actorSenderComponent <span class="token operator">=</span> Game<span class="token punctuation">.</span>Scene<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ActorSenderComponent<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">ActorMessageSender</span> actorMessageSender <span class="token operator">=</span> actorSenderComponent<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span>unitGateComponent<span class="token punctuation">.</span>GateSessionActorId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// send</span>
actorMessageSender<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// rpc</span>
<span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> actorMessageSender<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>The question is how do you know the InstanceId of the gate session in map? This is where you need to find a way to pass it on, for example in ET, when the player is logging in to gate, the gate session hooks up a mailbox MailBoxComponent, C2G_LoginGateHandler.cs</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code>session<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MailBoxComponent<span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>MailboxType<span class="token punctuation">.</span>GateSession<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>The InstanceId of this gate session is brought into the map when the player logs into the map process, in C2G_EnterMapHandler.cs</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code><span class="token class-name">M2G_CreateUnit</span> createUnit <span class="token operator">=</span> <span class="token punctuation">(</span>M2G_CreateUnit<span class="token punctuation">)</span><span class="token keyword">await</span> mapSession<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">G2M_CreateUnit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> PlayerId <span class="token operator">=</span> player<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> GateSessionId <span class="token operator">=</span> session<span class="token punctuation">.</span> InstanceId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="handling-of-actor-messages"><a href="#handling-of-actor-messages" class="header-anchor">#</a> Handling of Actor messages</h3> <p>First, the message arrives at the MailboxComponent, which has a type, and different types of mailboxes can do different processing. Currently, there are two types of mailboxes, GateSession and MessageDispatcher; GateSession mailboxes will immediately forward messages to the client when they are received, and MessageDispatcher types will again distribute the Actor messages to the specific Handler for processing. The default MailboxComponent type is MessageDispatcher. customizing a mailbox type is also very simple, inherit the IMailboxHandler interface and add the MailboxHandler tag. So why do we need to add such a feature? This feature does not exist in other actor models, and messages are generally received and distributed. The reason is that GateSession is not designed for distribution, so I added the mailbox type here. messageDispatcher has two ways of handling messages, one is to handle the messages sent by the other party, and the other is rpc messages</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code>    <span class="token comment">// To handle Send messages, you need to inherit the AMActorHandler abstract class. The first generic parameter of the abstract class is the type of the Actor, and the second parameter is the type of the message</span>
	<span class="token punctuation">[</span><span class="token function">ActorMessageHandler</span><span class="token punctuation">(</span>AppType<span class="token punctuation">.</span>Map<span class="token punctuation">)</span><span class="token punctuation">]</span>
	<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Actor_TestHandler</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AMActorHandler<span class="token punctuation">&lt;</span>Unit<span class="token punctuation">,</span> Actor_Test<span class="token punctuation">&gt;</span></span></span>
	<span class="token punctuation">{</span>
		<span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name">ETTask</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token class-name">Unit</span> unit<span class="token punctuation">,</span> <span class="token class-name">Actor_Test</span> message<span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			Log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>Info<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

    <span class="token comment">// To handle Rpc messages, you need to inherit the AMActorRpcHandler abstract class, the first generic parameter of the abstract class is the type of the Actor, the second parameter is the type of the message, and the third parameter is the type of the returned message</span>
    <span class="token punctuation">[</span><span class="token function">ActorMessageHandler</span><span class="token punctuation">(</span>AppType<span class="token punctuation">.</span>Map<span class="token punctuation">)</span><span class="token punctuation">]</span>
	<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Actor_TransferHandler</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AMActorRpcHandler<span class="token punctuation">&lt;</span>Unit<span class="token punctuation">,</span> Actor_TransferRequest<span class="token punctuation">,</span> Actor_TransferResponse<span class="token punctuation">&gt;</span></span></span>
	<span class="token punctuation">{</span>
		<span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token return-type class-name">ETTask</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token class-name">Unit</span> unit<span class="token punctuation">,</span> <span class="token class-name">Actor_TransferRequest</span> message<span class="token punctuation">,</span> <span class="token class-name">Action<span class="token punctuation">&lt;</span>Actor_TransferResponse<span class="token punctuation">&gt;</span></span> reply<span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token class-name">Actor_TransferResponse</span> response <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Actor_TransferResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">try</span>
			<span class="token punctuation">{</span>
				<span class="token function">reply</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
				<span class="token function">ReplyError</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> e<span class="token punctuation">,</span> reply<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>We should note that Actor messages have the potential to deadlock, such as A call to B, B call to C, and C call to A. Because MailboxComponent is essentially a message queue, it opens a concurrent process that will process one message at a time, returning ETTask to indicate that the message processing class will block MailboxComponent queue of other messages. So if there is a deadlock, we don't want a message processing to block the rest of the MailboxComponent messages, we can just open a new thread in the message processing class to handle it. For example:</p> <div class="language-csharp line-numbers-mode"><pre class="language-csharp"><code>	<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ActorMessageHandler</span><span class="token attribute-arguments"><span class="token punctuation">(</span>AppType<span class="token punctuation">.</span>Map<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
	<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Actor_TestHandler</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AMActorHandler<span class="token punctuation">&lt;</span>Unit<span class="token punctuation">,</span> Actor_Test<span class="token punctuation">&gt;</span></span></span>
	<span class="token punctuation">{</span>
		<span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name">ETTask</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token class-name">Unit</span> unit<span class="token punctuation">,</span> <span class="token class-name">Actor_Test</span> message<span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token function">RunAsync</span><span class="token punctuation">(</span>unit<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Coroutine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name">ETVoid</span> <span class="token function">RunAsync</span><span class="token punctuation">(</span><span class="token class-name">Unit</span> unit<span class="token punctuation">,</span> <span class="token class-name">Actor_Test</span> message<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">Debug</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>Info<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>For related information, you can Google the Actor deadlock problem.</p></div></div>  <div class="page-edit"><div class="edit-link"><a href="https://github.com/zxt385189207/ET-homepage/edit/main/docs/02.Guide/01.ETBook_English/54.5.4Actor Model.md" target="_blank" rel="noopener noreferrer">在Github上编辑此页面!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2022/07/25, 23:10:19</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/66fec6/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">Component-based design</div></a> <a href="/pages/d00821/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">Actor Location-EN</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/66fec6/" class="prev">Component-based design</a></span> <span class="next"><a href="/pages/d00821/">Actor Location-EN</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:385189207@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/egametang/ET" title="GitHub" target="_blank" class="iconfont icon-github"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2022-2022
    <span>d | MIT License</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ffc2a9fd.js" defer></script><script src="/assets/js/2.fbbdf61d.js" defer></script><script src="/assets/js/32.5b6b946d.js" defer></script>
  </body>
</html>
